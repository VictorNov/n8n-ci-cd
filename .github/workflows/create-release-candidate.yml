name: Create Release Candidate

permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  workflow_dispatch:
    inputs:
      workflow_name:
        description: 'Workflow base name for release candidate (e.g., "My Workflow")'
        required: true
      version:
        description: 'Release version (e.g., "1.0.0"). Leave empty to auto-increment'
        required: false
      version_increment:
        description: 'Version increment type when auto-incrementing'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

env:
  NODE_VERSION: '22'

jobs:
  create-release-candidate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup workflow variables
        id: setup
        run: |
          workflow_name="${{ github.event.inputs.workflow_name }}"
          
          # Generate consistent naming formats
          workflow_prefix=$(echo "$workflow_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/^-*//;s/-*$//' | sed 's/--*/-/g')
          workflow_filename=$(echo "$workflow_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/_/g' | sed 's/^_*//;s/_*$//')
          
          echo "workflow_name=$workflow_name" >> $GITHUB_OUTPUT
          echo "workflow_prefix=$workflow_prefix" >> $GITHUB_OUTPUT
          echo "workflow_filename=$workflow_filename" >> $GITHUB_OUTPUT
          echo "workflow_file=${workflow_filename}.json" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Workflow setup complete:"
          echo "  Name: $workflow_name"
          echo "  Prefix: $workflow_prefix"
          echo "  Filename: ${workflow_filename}.json"

      - name: Determine release version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            version="${{ github.event.inputs.version }}"
            echo "ðŸ·ï¸ Using provided version: $version"
          else
            echo "ðŸ” Auto-incrementing version..."
          
            workflow_prefix="${{ steps.setup.outputs.workflow_prefix }}"
            increment_type="${{ github.event.inputs.version_increment }}"
          
            # Find the latest tag for this workflow
            latest_tag=$(git tag -l "${workflow_prefix}-*" --sort=-version:refname | head -n1)
          
            if [ -z "$latest_tag" ]; then
              version="1.0.0"
              echo "ðŸ†• No previous tags found, starting with: $version"
            else
              current_version=$(echo "$latest_tag" | sed "s/${workflow_prefix}-//" | sed 's/^v//')
              echo "ðŸ“Š Current version: $current_version"
          
              if [[ $current_version =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
                major=${BASH_REMATCH[1]}
                minor=${BASH_REMATCH[2]}
                patch=${BASH_REMATCH[3]}
          
                case "$increment_type" in
                  "major")
                    version="$((major + 1)).0.0"
                    ;;
                  "minor")
                    version="${major}.$((minor + 1)).0"
                    ;;
                  "patch"|*)
                    version="${major}.${minor}.$((patch + 1))"
                    ;;
                esac
                echo "â¬†ï¸ Incremented to: $version"
              else
                version="1.0.0"
                echo "âš ï¸ Unexpected version format, defaulting to: $version"
              fi
            fi
          fi
          
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "RELEASE_VERSION=$version" >> $GITHUB_ENV

      - name: Inject API key
        run: |
          jq --arg key "${{ secrets.N8N_API_KEY }}" '.n8n.apiKey = $key' config/n8n-config.json > tmp.json && mv tmp.json config/n8n-config.json

      - name: Ensure prod branch exists
        run: |
          echo "ðŸŒ¿ Ensuring prod branch exists"
          node scripts/release-manager.js ensure-prod-branch

      - name: Analyze workflow changes
        run: |
          echo "ðŸ” Analyzing workflow changes"
          node scripts/release-manager.js analyze "${{ steps.setup.outputs.workflow_name }}" "${{ steps.version.outputs.version }}"

      - name: Create release tag
        id: tag
        run: |
          echo "ðŸ·ï¸ Creating release tag"
          tag_name=$(node scripts/release-manager.js create-tag "${{ steps.setup.outputs.workflow_name }}" "${{ steps.version.outputs.version }}")
          echo "tag_name=$tag_name" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$tag_name" >> $GITHUB_ENV

      - name: Create release candidate branch
        id: branch
        run: |
          echo "ðŸŒ¿ Creating release candidate branch"
          rc_branch=$(node scripts/release-manager.js create-branch "${{ steps.setup.outputs.workflow_name }}" "${{ steps.version.outputs.version }}")
          echo "rc_branch=$rc_branch" >> $GITHUB_OUTPUT
          echo "RC_BRANCH=$rc_branch" >> $GITHUB_ENV

      - name: Prepare PR body
        id: pr_body
        run: |
          if [ -f "workflow_changes.md" ]; then
            echo "WORKFLOW_CHANGES<<EOF" >> $GITHUB_OUTPUT
            cat workflow_changes.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "WORKFLOW_CHANGES=No workflow changes file found." >> $GITHUB_OUTPUT
          fi

      - name: Create pull request to prod
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ env.RC_BRANCH }}
          destination_branch: prod
          pr_title: "ðŸš€ Release ${{ steps.version.outputs.version }}: ${{ steps.setup.outputs.workflow_name }}"
          pr_body: |
            ## Release Candidate: ${{ steps.setup.outputs.workflow_name }} ${{ steps.version.outputs.version }}
            
            ### ðŸ“¦ Release Metadata
            ```yaml
            workflow_name: ${{ steps.setup.outputs.workflow_name }}
            workflow_prefix: ${{ steps.setup.outputs.workflow_prefix }}
            workflow_filename: ${{ steps.setup.outputs.workflow_filename }}
            workflow_file: ${{ steps.setup.outputs.workflow_file }}
            version: ${{ steps.version.outputs.version }}
            tag_name: ${{ env.TAG_NAME }}
            ```
            
            **Created by:** ${{ github.actor }}
            **Release Tag:** ${{ env.TAG_NAME }}
            **Version:** ${{ steps.version.outputs.version }} ${{ github.event.inputs.version && '(manually specified)' || format('(auto-incremented {0})', github.event.inputs.version_increment) }}
            
            ### ðŸ“‹ Pre-deployment Checklist
            - [ ] Dev workflow has been tested thoroughly
            - [ ] No critical issues identified
            - [ ] Stakeholders have been notified
            - [ ] Breaking changes documented
            - [ ] Rollback plan confirmed
            
            ### ðŸ“Š Workflow Changes
            
            ${{ steps.pr_body.outputs.WORKFLOW_CHANGES }}
            
            ### ðŸš¨ Important Notes
            - Merging this PR will automatically deploy to production
            - A backup will be created automatically before deployment
            
            ### ðŸ”„ Rollback Instructions
            If issues occur after deployment, use:
            ```bash
            npm run backup:restore [backup-name]
            ```
          github_token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          release_name: "${{ steps.setup.outputs.workflow_name }} ${{ steps.version.outputs.version }}"
          body_path: workflow_changes.md
          draft: false
          prerelease: false

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-candidate-${{ steps.setup.outputs.workflow_name }}-${{ steps.version.outputs.version }}
          path: |
            workflow_changes.md
            RELEASE_INFO_*.md
            workflows/${{ steps.setup.outputs.workflow_file }}